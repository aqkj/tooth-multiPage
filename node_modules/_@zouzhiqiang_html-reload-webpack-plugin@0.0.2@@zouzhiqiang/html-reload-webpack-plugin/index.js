/**
 * 重载plugin
 * @author xiaoqiang <465633678@qq.com>
 * @created 2019/08/27 14:32:45
 */
const io = require('socket.io')(8818)
class ReloadPlugin {
  apply(compiler) {
    compiler.hooks.compilation.tap('HtmlReloadWebpackPlugin', (compilation) => {
      compilation.hooks.htmlWebpackPluginBeforeHtmlProcessing.tapAsync('HtmlReloadWebpackPlugin', (htmlPluginData, callback) => {
          htmlPluginData.html += '<script src="http://localhost:8818/socket.io/socket.io.js"></script>';
          htmlPluginData.html += '<script>var socket = io.connect("http://localhost:8818");socket.on("reload", function(){window.location.reload()});</script>'
          callback(null, htmlPluginData);
      })
      compilation.hooks.htmlWebpackPluginAfterEmit.tapAsync('HtmlReloadWebpackPlugin', (htmlPluginData, callback) => {
        io.emit('reload');
        callback(null, htmlPluginData);
      })
    })
  }
}
module.exports = ReloadPlugin;